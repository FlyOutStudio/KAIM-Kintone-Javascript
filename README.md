# Kintone 最新仕入価格取得カスタマイズ

このカスタマイズは、Kintoneアプリケーションで「過去の最新単価を取得する」ボタンを追加し、自動的に価格情報を取得・更新する機能を提供します。

## 機能概要

### 主要機能
1. **過去の最新単価取得**：同一商品の過去レコード（納品日最新）から仕入価格・売価格を自動取得
2. **価格変動区分自動判定**：据え置き / 値上がり / 値下がり / 未入力の自動判定
3. **特価区分同期**：過去レコードの特価区分を今回レコードに自動コピー
4. **条件付き自動入力**：据え置き・値下がりの場合、過去の最新売単価を今回売単価に自動入力

### 動作フロー
```
1. ボタンクリック（一覧画面または詳細画面）
   ↓
2. 同一商品レコードを納品日で検索
   ↓
3. 納品日最新のレコードから価格情報を取得
   ↓
4. 今回価格と過去価格を比較し変動区分を判定
   ↓
5. 過去最新価格・特価区分・変動区分を更新
   ↓
6. 条件に応じた売単価自動入力
```

## ファイル構成

```
kintone-customization/
├── config.js          # 設定ファイル（フィールドコード、UI設定等）
├── price-logic.js     # 価格変動判定ロジック
├── main.js            # メイン処理（ボタン配置、API呼び出し）
└── README.md          # このファイル
```

## セットアップ手順

### 1. ファイルのアップロード
Kintoneアプリの設定画面で、以下の順序でJavaScriptファイルをアップロード：
1. `config.js`
2. `price-logic.js`
3. `main.js`

### 2. フィールドコードの設定
`config.js`の`FIELDS`オブジェクトを実際のアプリのフィールドコードに合わせて修正：

```javascript
FIELDS: {
    CURRENT_PURCHASE_PRICE: '今回仕入単価',      // 実際のフィールドコードに変更
    CURRENT_SELLING_PRICE: '今回売単価',        // 実際のフィールドコードに変更
    PAST_LATEST_PURCHASE_PRICE: '過去最新仕入単価',
    PAST_LATEST_SELLING_PRICE: '過去最新売単価',
    PRICE_CHANGE_CATEGORY: '仕入価格変動区分',
    STORE_NAME: '顧客名',           // 店舗名のフィールドコード
    STORE_CODE: '現場コード',       // 現場コードのフィールドコード
    PRODUCT_NAME: '商品名',         // 商品名のフィールドコード
    // ... その他必要に応じて調整
}
```

### 3. フィールド設定
以下のフィールドがアプリに存在することを確認：

#### 価格変動区分フィールドの選択肢：
- 据え置き
- 値上がり
- 値下がり
- 未入力

#### 必要フィールド：
- 今回仕入単価
- 今回売単価
- 過去最新仕入単価
- 過去最新売単価
- 特価区分
- 納品日
- 商品名

### 4. アクセス権限の確認
- JavaScript実行権限
- レコード読み取り権限
- レコード編集権限

## 設定可能項目

### CONFIG.js の主要設定項目

```javascript
// 検索設定
SEARCH: {
    MAX_RECORDS: 100,           // 検索結果の最大件数
    SEARCH_DAYS_BACK: 365,      // 検索対象期間（日数）
    EXCLUDE_CATEGORIES: ['送料'] // 除外する価格変動区分
},

// UI設定
UI: {
    BUTTON_TEXT: '過去の最新単価を取得する',
    BUTTON_STYLE: {
        backgroundColor: '#3498db',
        color: 'white',
        // ... その他スタイル
    }
},

// デバッグ設定
DEBUG: {
    ENABLED: true,              // ログ出力の有効/無効
    PREFIX: '[価格取得カスタマイズ]'
}
```

## 価格変動判定ロジック

### 判定条件
1. **送料判定**：商品名に「送料」「配送料」等のキーワードが含まれる場合
2. **値上がり**：今回仕入単価 > 過去最新仕入単価
3. **据え置き**：今回仕入単価 = 過去最新仕入単価、または価格下降
4. **未入力**：価格情報が不足している場合

### 自動処理
- **据え置き**：過去の最新売単価 → 今回売単価に自動入力
- **値上がり**：レコード行の背景色を薄い赤色に変更

## API仕様

### 使用するKintone API
- `kintone.api()` - レコード検索・取得
- `kintone.app.record.get()` - 現在レコード取得
- `kintone.app.record.set()` - レコード更新

### 検索クエリ例
```javascript
query: '商品名 = "商品A" and 顧客名 = "店舗B" and 更新日時 >= "2023-01-01T00:00:00Z"'
```

## トラブルシューティング

### よくある問題と解決方法

1. **ボタンが表示されない**
   - フィールドコードの設定を確認
   - JavaScript実行権限を確認
   - ブラウザのコンソールでエラーを確認

2. **過去データが見つからない**
   - 検索条件（商品名、店舗名等）が正確か確認
   - 検索対象期間（SEARCH_DAYS_BACK）を調整
   - 除外カテゴリ設定を確認

3. **価格変動区分が正しく設定されない**
   - フィールドの選択肢設定を確認
   - 価格データの形式を確認（数値型か文字列型か）

### デバッグ方法
1. `CONFIG.DEBUG.ENABLED = true` でログ出力を有効化
2. ブラウザの開発者ツールでコンソールログを確認
3. エラーメッセージとログ情報を組み合わせて問題を特定

## 制限事項

- 検索対象は最大100件のレコード
- 同一商品・店舗の過去データが必要
- アプリ間を跨いだ検索は不可
- 大量データ処理時のパフォーマンス制限

## カスタマイズ例

### 検索条件の変更
```javascript
// price-logic.js の buildSearchQuery() をカスタマイズ
buildSearchQuery: function(currentRecord) {
    // 独自の検索条件を追加
    // 例：特定の期間のみを対象とする
    // 例：特定の担当者のデータのみを検索
}
```

### UI の変更
```javascript
// config.js の UI 設定をカスタマイズ
UI: {
    BUTTON_TEXT: 'カスタムボタンテキスト',
    BUTTON_STYLE: {
        backgroundColor: '#e74c3c', // 赤色ボタン
        fontSize: '16px'
    }
}
```

## ライセンス

このカスタマイズはMITライセンスの下で提供されます。

## サポート

問題や質問がある場合は、開発チームまでお問い合わせください。